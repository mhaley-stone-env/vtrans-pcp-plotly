<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stacked Area Chart - ArcGIS + Plotly</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div id="chart" style="width: 100%; height: 800px;"></div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  const serviceUrl =
    "https://services.arcgis.com/pwNwIGBE7M7VOXjQ/arcgis/rest/services/LCB_Implementation_Model_Cumulative_Table/FeatureServer/0/query";
  const queryUrl = `${serviceUrl}?where=1=1&outFields=*&f=json&orderByFields=Years`;

  const segmentColors = {
    "South Lake B": "#1f77b4",
    "South Lake A": "#ff7f0e",
    "Port Henry": "#2ca02c",
    "Otter Creek": "#d62728",
    "Main Lake": "#9467bd",
    "Shelburne Bay": "#8c564b",
    "Burlington Bay": "#e377c2",
    "Malletts Bay": "#7f7f7f",
    "Northeast Arm": "#bcbd22",
    "St. Albans Bay": "#17becf",
    "Mississquoi Bay": "#aec7e8",
    "Isle La Motte": "#ffbb78"
  };

  fetch(queryUrl)
    .then((response) => response.json())
    .then((data) => {
      if (!data.features || data.features.length === 0) {
        document.getElementById("chart").innerHTML = "<p>No data found.</p>";
        return;
      }

      const features = data.features;
      const sample = features[0].attributes;
      const allFields = Object.keys(sample);
      const segments = allFields.filter(
        (f) => f !== "Years" && f !== "ESRI_OID"
      );

      const years = features.map((f) => f.attributes.Years);

      // Create stacked traces
      let traces = segments.map((segment) => {
        return {
          x: years,
          y: features.map((f) => f.attributes[segment]),
          stackgroup: "one",
          mode: "lines",
          name: segment,
          line: { color: segmentColors[segment] || undefined },
          hovertemplate: `${segment} - %{y:.2f}<extra></extra>`
        };
      });

      // Calculate total for each year
      const totals = years.map((year, i) => {
        return segments.reduce((sum, segment) => {
          return sum + (features[i].attributes[segment] || 0);
        }, 0);
      });

      // Add text trace for totals
      traces.push({
        x: years,
        y: totals,
        text: totals.map((val) => val.toFixed(1)),
        mode: "text",
        textposition: "top center",
        textfont: { color: "grey", size: 10 },
        hoverinfo: "skip",
        showlegend: false
      });

      const targetValue = 1605.9;

      // Guide bar points
      const guidePoints = [
        { x: 2020, y: 401.5, text: "Phase 1 (25% of Target)" },
        { x: 2024, y: 803.0, text: "Phase 2 (50% of Target)" },
        { x: 2028, y: 1204.4, text: "Phase 3 (75% of Target)" },
        { x: 2032, y: 1605.9, text: "" } // last one without text
      ];

      // Add vertical guide bars
      const shapes = [
        {
          type: "line",
          x0: 2010,
          x1: 2036,
          y0: targetValue,
          y1: targetValue,
          xref: "x",
          yref: "y",
          line: { color: "green", width: 2, dash: "dash" }
        },
        ...guidePoints.map((p) => ({
          type: "line",
          x0: p.x,
          x1: p.x,
          y0: 0,
          y1: p.y,
          xref: "x",
          yref: "y",
          line: { color: "lightgrey", width: 1, dash: "dot" }
        }))
      ];

      // Add circle markers at top of vertical lines
      traces.push({
        x: guidePoints.map((p) => p.x),
        y: guidePoints.map((p) => p.y),
        mode: "markers",
        marker: { color: "lightgrey", size: 10 },
        hoverinfo: "skip",
        showlegend: false
      });

      // Add annotations for the first 3 guide points
      const annotations = [
        {
          x: 2013,
          y: targetValue + 50,
          xref: "x",
          yref: "y",
          text: "Phase 4 & Total Target P Load Reduction (kg/year): 1,605.9",
          font: { color: "black", size: 12 },
          showarrow: false,
          align: "left"
        },
        ...guidePoints
          .filter((p) => p.text)
          .map((p) => ({
            x: p.x,
            y: p.y + 100, // shifted higher above circle
            xref: "x",
            yref: "y",
            text: p.text,
            font: { color: "black", size: 11 },
            showarrow: false,
            align: "center"
          }))
      ];

      const layout = {
        title: "Implementation Model Cumulative by Lake Segment",
        height: 800, // fixed larger height
        xaxis: { 
          title: "Year",
          range: [2010, 2036]
        },
        yaxis: { title: "Phosphorus Load Reduction (kg/year)" },
        legend: { orientation: "v", x: 1.05, y: 1 },
        margin: { r: 250 },
        hovermode: "x unified",
        shapes: shapes,
        annotations: annotations
      };

      const config = { responsive: true };

      Plotly.newPlot("chart", traces, layout, config);
    })
    .catch((error) => {
      console.error("Error fetching data:", error);
      document.getElementById("chart").innerHTML =
        "<p>Error loading data.</p>";
    });
</script>
</body>
</html>
